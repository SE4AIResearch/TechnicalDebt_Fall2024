<html><head>
<style> table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}th {
  background: lightblue;
}</style>
</head> <body><h1>SATD</h1><table><tr><th>satd id</th> <th>satd instance id</th>  <th>project</th> <th>committer name </th> <th> Commit Hash</th> <th>old comment</th> <th>New Comment</th> <th>resolution</th> <th>Method Signature</th> <th>Method Declaration</th> <th>Method Body</th> </tr><tr><td>5276</td> <td>-1009652446</td><td>apache/hadoop</td><td>Eli Collins</td><td>a196766ea07775f18ded69bd9e8d239f8cfd3ccc</td> <td>None</td> <td>Private Distributed cache will always be stored under
mapre.local.dir/taskTracker/<username>/distcache
Checking for username directory to check if it has the
proper permissions</td> <td>SATD_ADDED</td> <td>testDistributedCache()</td> <td>public void testDistributedCache() throws Exception</td> <td>
    Configuration conf = new Configuration(cluster.getConf());
    JTProtocol wovenClient = cluster.getJTClient().getProxy();
    // This counter will check for count of a loop,
    // which might become infinite.
    int count = 0;
    SleepJob job = new SleepJob();
    job.setConf(conf);
    Job slpJob = job.createJob(5, 1, 1000, 1000, 100, 100);
    DistributedCache.createSymlink(conf);
    URI uri = URI.create(uriPath);
    DistributedCache.addCacheFile(uri, conf);
    JobConf jconf = new JobConf(conf);
    // Controls the job till all verification is done
    FinishTaskControlAction.configureControlActionForJob(conf);
    // Submitting the job
    slpJob.submit();
    RunningJob rJob = cluster.getJTClient().getClient().getJob(org.apache.hadoop.mapred.JobID.downgrade(slpJob.getJobID()));
    JobStatus[] jobStatus = client.getAllJobs();
    String userName = jobStatus[0].getUsername();
    TTClient tClient = null;
    JobInfo jInfo = wovenClient.getJobInfo(rJob.getID());
    LOG.info("jInfo is :" + jInfo);
    // Assert if jobInfo is null
    Assert.assertNotNull("jobInfo is null", jInfo);
    // Wait for the job to start running.
    count = 0;
    while (jInfo.getStatus().getRunState() != JobStatus.RUNNING) {
        UtilsForTests.waitFor(10000);
        count++;
        jInfo = wovenClient.getJobInfo(rJob.getID());
        // If the count goes beyond a point, then Assert; This is to avoid
        // infinite loop under unforeseen circumstances.
        if (count > 10) {
            Assert.fail("job has not reached running state for more than" + "100 seconds. Failing at this point");
        }
    }
    LOG.info("job id is :" + rJob.getID().toString());
    TaskInfo[] taskInfos = cluster.getJTClient().getProxy().getTaskInfo(rJob.getID());
    boolean distCacheFileIsFound;
    for (TaskInfo taskInfo : taskInfos) {
        distCacheFileIsFound = false;
        String[] taskTrackers = taskInfo.getTaskTrackers();
        for (String taskTracker : taskTrackers) {
            // Getting the exact FQDN of the tasktracker from
            // the tasktracker string.
            taskTracker = UtilsForTests.getFQDNofTT(taskTracker);
            tClient = cluster.getTTClient(taskTracker);
            String[] localDirs = tClient.getMapredLocalDirs();
            int distributedFileCount = 0;
            String localDirOnly = null;
            boolean FileNotPresentForThisDirectoryPath = false;
            // Go to every single path
            for (String localDir : localDirs) {
                FileNotPresentForThisDirectoryPath = false;
                localDirOnly = localDir;
                // Public Distributed cache will always be stored under
                // mapred.local.dir/tasktracker/archive
                localDirOnly = localDir + Path.SEPARATOR + TaskTracker.SUBDIR + Path.SEPARATOR + userName;
                // Private Distributed cache will always be stored under
                // mapre.local.dir/taskTracker/<username>/distcache
                // Checking for username directory to check if it has the
                // proper permissions
                localDir = localDir + Path.SEPARATOR + TaskTracker.getPrivateDistributedCacheDir(userName);
                FileStatus fileStatusMapredLocalDirUserName = null;
                try {
                    fileStatusMapredLocalDirUserName = tClient.getFileStatus(localDirOnly, true);
                } catch (Exception e) {
                    LOG.info("LocalDirOnly :" + localDirOnly + " not found");
                    FileNotPresentForThisDirectoryPath = true;
                }
                // File will only be stored under one of the mapred.lcoal.dir
                // If other paths were hit, just continue
                if (FileNotPresentForThisDirectoryPath)
                    continue;
                Path pathMapredLocalDirUserName = fileStatusMapredLocalDirUserName.getPath();
                FsPermission fsPermMapredLocalDirUserName = fileStatusMapredLocalDirUserName.getPermission();
                Assert.assertTrue("Directory Permission is not 700", fsPermMapredLocalDirUserName.equals(new FsPermission("700")));
                // Get file status of all the directories
                // and files under that path.
                FileStatus[] fileStatuses = tClient.listStatus(localDir, true, true);
                for (FileStatus fileStatus : fileStatuses) {
                    Path path = fileStatus.getPath();
                    LOG.info("path is :" + path.toString());
                    // Checking if the received path ends with
                    // the distributed filename
                    distCacheFileIsFound = (path.toString()).endsWith(distributedFileName);
                    // If file is found, check for its permission.
                    // Since the file is found break out of loop
                    if (distCacheFileIsFound) {
                        LOG.info("PATH found is :" + path.toString());
                        distributedFileCount++;
                        String filename = path.getName();
                        FsPermission fsPerm = fileStatus.getPermission();
                        Assert.assertTrue("File Permission is not 777", fsPerm.equals(new FsPermission("777")));
                    }
                }
            }
            LOG.info("Distributed File count is :" + distributedFileCount);
            if (distributedFileCount > 1) {
                Assert.fail("The distributed cache file is more than one");
            } else if (distributedFileCount < 1)
                Assert.fail("The distributed cache file is less than one");
            if (!distCacheFileIsFound) {
                Assert.assertEquals("The distributed cache file does not exist", distCacheFileIsFound, false);
            }
        }
        // Allow the job to continue through MR control job.
        for (TaskInfo taskInfoRemaining : taskInfos) {
            FinishTaskControlAction action = new FinishTaskControlAction(TaskID.downgrade(taskInfoRemaining.getTaskID()));
            Collection<TTClient> tts = cluster.getTTClients();
            for (TTClient cli : tts) {
                cli.getProxy().sendAction(action);
            }
        }
        // Killing the job because all the verification needed
        // for this testcase is completed.
        rJob.killJob();
    }
</td> </tr></table></body></html>