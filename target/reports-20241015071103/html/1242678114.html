<html><head>
<style> table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}th {
  background: lightblue;
}</style>
</head> <body><h1>SATD</h1><table><tr><th>satd id</th> <th>satd instance id</th>  <th>project</th> <th>committer name </th> <th> Commit Hash</th> <th>old comment</th> <th>New Comment</th> <th>resolution</th> <th>Method Signature</th> <th>Method Declaration</th> <th>Method Body</th> </tr><tr><td>4896</td> <td>1242678114</td><td>GerritCodeReview/gerrit</td><td>David Pursehouse</td><td>e6ac4ad532f01d5efeaaa6033dfb1e167d2dc0c8</td> <td>None</td> <td>We try to retrieve claimed identity.
For some reason, for example staging instance
it may deviate from the really old OpenID identity.
What we want to avoid in any event is to create new
account instead of linking to the existing one.
That why we query it here, not to lose linking mode.</td> <td>SATD_ADDED</td> <td>authenticateAndRedirect(HttpServletRequest, HttpServletResponse)</td> <td>private void authenticateAndRedirect(HttpServletRequest req, HttpServletResponse rsp) throws IOException</td> <td>
    com.google.gerrit.server.account.AuthRequest areq = new com.google.gerrit.server.account.AuthRequest(user.getExternalId());
    AuthResult arsp = null;
    try {
        String claimedIdentifier = user.getClaimedIdentity();
        Account.Id actualId = accountManager.lookup(user.getExternalId());
        Account.Id claimedId = null;
        // We try to retrieve claimed identity.
        // For some reason, for example staging instance
        // it may deviate from the really old OpenID identity.
        // What we want to avoid in any event is to create new
        // account instead of linking to the existing one.
        // That why we query it here, not to lose linking mode.
        if (!Strings.isNullOrEmpty(claimedIdentifier)) {
            claimedId = accountManager.lookup(claimedIdentifier);
            if (claimedId == null) {
                log.debug("Claimed identity is unknown");
            }
        }
        // Use case 1: claimed identity was provided during handshake phase
        // and user account exists for this identity
        if (claimedId != null) {
            log.debug("Claimed identity is set and is known");
            if (actualId != null) {
                if (claimedId.equals(actualId)) {
                // Both link to the same account, that's what we expected.
                } else {
                    // This is (for now) a fatal error. There are two records
                    // for what might be the same user. The admin would have to
                    // link the accounts manually.
                    log.error("OAuth accounts disagree over user identity:\n" + "  Claimed ID: " + claimedId + " is " + claimedIdentifier + "\n" + "  Delgate ID: " + actualId + " is " + user.getExternalId());
                    rsp.sendError(HttpServletResponse.SC_FORBIDDEN);
                    return;
                }
            } else {
                // Claimed account already exists: link to it.
                // 
                try {
                    accountManager.link(claimedId, areq);
                } catch (OrmException e) {
                    log.error("Cannot link: " + user.getExternalId() + " to user identity:\n" + "  Claimed ID: " + claimedId + " is " + claimedIdentifier);
                    rsp.sendError(HttpServletResponse.SC_FORBIDDEN);
                    return;
                }
            }
        } else if (linkMode) {
            // Use case 2: link mode activated from the UI
            try {
                accountManager.link(identifiedUser.get().getAccountId(), areq);
            } catch (OrmException e) {
                log.error("Cannot link: " + user.getExternalId() + " to user identity: " + identifiedUser.get().getAccountId());
                rsp.sendError(HttpServletResponse.SC_FORBIDDEN);
                return;
            } finally {
                linkMode = false;
            }
        }
        areq.setUserName(user.getUserName());
        areq.setEmailAddress(user.getEmailAddress());
        areq.setDisplayName(user.getDisplayName());
        arsp = accountManager.authenticate(areq);
    } catch (AccountException e) {
        log.error("Unable to authenticate user \"" + user + "\"", e);
        rsp.sendError(HttpServletResponse.SC_FORBIDDEN);
        return;
    }
    webSession.get().login(arsp, true);
    StringBuilder rdr = new StringBuilder(urlProvider.get(req));
    rdr.append(Url.decode(redirectToken));
    rsp.sendRedirect(rdr.toString());
</td> </tr></table></body></html>